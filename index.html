<head>
    <link rel="stylesheet" href="style.css" />
    <script src="https://unpkg.com/three"></script>
    <script src="https://unpkg.com/three/examples/js/controls/TrackballControls.js"></script>
    <script src="https://unpkg.com/three-globe"></script>
    <title>BTC globe</title>
</head>

<body>
    <div class="container">
        <div id="globeViz"></div>
        <div class="top-left">
            <h1>Latest</h1>
            <div id="latest-list"></div>
        </div>

        <p class="bottom">
            Showing realtime Bitcoin transactions |
            <a href="https://github.com/Tomasroma64/btc-globe">GitHub</a> feel free to submit a pull request | by
            <a href="http://tomasmaillo.com">tomasmaillo</a>
        </p>
    </div>

    <script>
        function map(value, currentLow, currentUpp, targetLow, targetUpp) {
            return (value / (currentUpp - currentLow)) * (targetUpp - targetLow) * 10;
        }

        const gData = [];

        const Globe = new ThreeGlobe()
            .globeImageUrl("https://i.imgur.com/tgaY68U.jpg")
            .bumpImageUrl("https://i.imgur.com/zV0auTO.png")
            .showGraticules(false)
            .pointsData(gData)
            .pointRadius(0.1)
            .pointResolution(15)
            .pointsMerge(false)
            .pointsTransitionDuration(1000)
            .pointAltitude("size")
            .pointColor("color");

        var exampleSocket = new WebSocket("wss://blocks.wizb.it/ws", [
            "protocolOne",
            "protocolTwo",
        ]);
        exampleSocket.onmessage = function(event) {
            var text = "";
            var msg = JSON.parse(event.data);
            console.log(msg);

            // Append data to point array
            gData.push({
                lat: msg.lat,
                lng: msg.lon,
                size: map(parseInt(msg.amount), 0, 1000, 0, 20),
                color: "white",
            });

            // Construct Transaction Log HTML
            // TODO: add expiry date for transaction log
            if (msg.amount) {
                var amount = document.createElement("P");
                amount.innerText = "amount: " + (msg.amount || "... ") + "btc";

                var location = document.createElement("P");
                location.innerText =
                    "location: " + (msg.lat || "...") + " " + (msg.lon || "...");
                var block = document.createElement("div");
                block.classList.add("transaction");

                block.appendChild(amount);
                block.appendChild(location);

                var container = document.getElementById("latest-list");
                container.insertBefore(block, container.firstChild);
            }

            Globe.pointsData(gData);
        };

        // Setup renderer
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById("globeViz").appendChild(renderer.domElement);

        // Setup scene
        const scene = new THREE.Scene();
        scene.add(Globe);
        scene.add(new THREE.AmbientLight(0xbbbbbb));
        scene.add(new THREE.DirectionalLight(0xffffff, 0.6));

        // Setup camera
        const camera = new THREE.PerspectiveCamera();
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        camera.position.z = 300;

        // Add camera controls
        const tbControls = new THREE.TrackballControls(camera, renderer.domElement);
        tbControls.minDistance = 110;
        tbControls.maxDistance = 1500;
        tbControls.rotateSpeed = 5;
        tbControls.zoomSpeed = 0.7;

        // Kick-off renderer
        (function animate() {
            // IIFE
            // Frame cycle
            tbControls.update();
            renderer.render(scene, camera);
            requestAnimationFrame(animate);
        })();
    </script>
</body>